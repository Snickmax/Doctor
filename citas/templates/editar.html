<div class="container-fluid">
    <form id="editarForm" method="post" enctype="multipart/form-data">
      {% csrf_token %}
      <!-- Nombre de Usuario -->
      <div class="form-floating">
        <input id="username" type="text" name="username" class="form-control editable" value="{{ form.username.value }}"
          placeholder="Nombre de usuario" maxlength="150" required disabled />
        <label for="username">Nombre de usuario</label>
        <div class="invalid-feedback">Por favor ingrese un nombre de usuario.</div>
      </div>
      <!-- Primer Nombre -->
      <div class="form-floating" style="margin-top: 10px">
        <input id="first_name" type="text" name="first_name" class="form-control editable" value="{{ form.first_name.value }}"
          placeholder="Nombre" maxlength="150" required disabled />
        <label for="first_name">Nombre</label>
        <div class="invalid-feedback"></i>Por favor ingrese el nombre.</div>
      </div>
      <!-- Primer Apellido -->
      <div class="form-floating" style="margin-top: 10px">
        <input id="last_name" type="text" name="last_name" class="form-control editable"
          value="{{ form.last_name.value }}" maxlength="150" placeholder="Apellido paterno" required disabled />
        <label for="last_name">Apellido paterno</label>
        <div class="invalid-feedback"></i>Por favor ingrese el apellido paterno.</div>
      </div>
      <!-- Segundo Apellido -->
      <div class="form-floating" style="margin-top: 10px">
        <input id="last_name2" type="text" name="last_name2" class="form-control editable"
          value="{{ form.last_name2.value }}" maxlength="150" placeholder="Apellido materno" required disabled />
        <label for="last_name2">Apellido materno</label>
        <div class="invalid-feedback"></i>Por favor ingrese el apellido materno.</div>
      </div>
      <!-- Correo -->
      <div class="form-floating" style="margin-top: 10px">
        <input id="email" type="email" name="email" class="form-control editable" value="{{ form.email.value }}"
          placeholder="Correo" maxlength="254" required disabled />
        <label for="email">Correo</label>
        <div class="invalid-feedback"></i>Por favor ingrese el correo.</div>
      </div>
      <div class="form-floating" style="margin-top: 10px">
        <select id="is_active" name="is_active" class="form-control editable" disabled>
          {% for is_active_value, is_active_display in form.is_active.field.choices %}
          <option value="{{ is_active_value }}" {% if form.instance.is_active == is_active_value %}selected{% endif %}>
            {{ is_active_display }}
          </option>
          {% endfor %}
        </select>
        <input type="hidden" id="is_active_hidden" name="is_active" value="{{ form.instance.is_active|yesno:"1,0" }}">
        <label for="is_active">Estado</label>
        <div class="invalid-feedback">Por favor ingrese el estado.</div>
      </div>
      <div class="field-row" style="margin-top: 10px; display: flex; justify-content: space-between">
        <!-- Fecha de Registro -->
        <div class="form-floating" style="flex: 1; margin-right: 10px">
          <input id="date_joined" type="text" name="date_joined" class="form-control"
            value="{{ form.instance.date_joined|date:'d/m/Y h:i' }}" placeholder="Fecha de registro" disabled />
          <label for="date_joined">Fecha de registro</label>
        </div>
        <!-- Fecha de ultimo inicio de sesion -->
        <div class="form-floating" style="flex: 1">
          <input id="last_login" type="text" name="last_login" class="form-control"
            value="{{ form.instance.last_login|date:'d/m/Y h:i' }}" placeholder="Último inicio de sesión" disabled />
          <label for="last_login">Último inicio de sesión</label>
        </div>
      </div>
      <div class="alert alert-success" role="alert" style="display: none; margin-top: 10px"></div>
      <!-- Botones -->
      <div style="display: flex; justify-content: space-between;">
        <div style="text-align: left">
          <button id="btnEditarContraseña" type="button" class="btn btn-primary mt-3 btn-lg btn-edit-pass"
            data-form-type="pass" data-bs-target="#modalBase" data-user-id="{{ form.instance.id }}">
            Cambiar Contraseña
          </button>
        </div>
        <div style="text-align: right">
          <button id="editButton" type="button" class="btn btn-primary mt-3 btn-lg">
            Editar
          </button>
          <button id="submitButton" type="submit" class="btn btn-primary mt-3 btn-lg" style="display: none">
            <span id="spinner" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"
              style="display: none;"></span>
            Guardar
          </button>
          <button id="cancelButton" type="button" class="btn btn-primary mt-3 btn-lg" style="display: none">
            Cancelar
          </button>
        </div>
      </div>
    </form>
  </div>
  
  <script>
    $(document).ready(function () {
      var originalValues = {};
      var loggedInUserId = "{{ user.id }}";
      document.getElementById("editButton").addEventListener("click", function () {
        // Habilitar solo los campos con la clase 'editable'
        Array.from(document.getElementsByClassName("editable")).forEach(function (
          element
        ) {
          // Almacenar el valor original del campo
          originalValues[element.id] = element.value;
          if (element.id === 'is_active' && loggedInUserId === "{{ user_id }}") {
            element.disabled = true;
            document.getElementById("is_active_hidden").disabled = false;
          } else {
            element.disabled = false;
            if (element.id === 'is_active') {
              document.getElementById("is_active_hidden").disabled = true;
            }
          }
        });
  
        // Mostrar los botones "Guardar" y "Cancelar"
        document.getElementById("submitButton").style.display = "inline";
        document.getElementById("cancelButton").style.display = "inline";
        document.getElementById("editButton").style.display = "none";
        document.getElementById("btnEditarContraseña").style.display = "none";
      });
  
      document.getElementById("cancelButton").addEventListener("click", function () {
        // Deshabilitar los campos del formulario y restablecer a los valores originales
        Array.from(document.getElementsByClassName("editable")).forEach(function (
          element
        ) {
          element.value = originalValues[element.id];
          element.disabled = true;
        });
        
        //Limpia clases de validacion
        $(".is-invalid").removeClass("is-invalid");
        $(".is-valid").removeClass("is-valid");
        $(".invalid-feedback").html("");
        $("#submitButton").removeClass("btn-danger");
        $("#submitButton").addClass("btn-primary");
  
        // Ocultar los botones "Guardar" y "Cancelar"
        document.getElementById("submitButton").style.display = "none";
        document.getElementById("cancelButton").style.display = "none";
        document.getElementById("editButton").style.display = "inline";
        document.getElementById("editButton").disabled = false;
        document.getElementById("btnEditarContraseña").style.display = "inline";
      });
  
      $("#btnEditarContraseña").click(function () {
        var userId = $(this).data("user-id"); // Obtiene el ID del usuario
        var requestData = { form_type: "pass" }; // Inicializa los datos de la solicitud
  
        // Agrega el ID del usuario a los datos de la solicitud
        if (userId) {
          requestData.user_id = userId;
        }
        $.ajax({
          url: "/home/cargar_formulario/", // Ruta a la vista que devuelve el formulario
          type: "GET",
          data: requestData, // Envía el tipo de formulario y el ID del usuario a la vista
          success: function (response) {
            $("#modalBase .modal-body").empty(); // Vacía el cuerpo del modal
            $("#modalBase .modal-body").html(response.form_html); // Carga el nuevo formulario en el cuerpo del modal
            $("#modalBase .modal-title").html(response.titulo_modal);
            $("#editarForm").attr("data-user-id", userId);
          },
          error: function (xhr, errmsg, err) {
          },
        });
      });
    });
  </script>